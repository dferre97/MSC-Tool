% !TEX root = ../popl-paper.tex

% \begin{figure}[ht]
% 	\begin{center}
% 	\includegraphics[width=10cm]{stw_bound}
% 	\end{center}
% \end{figure}

In this section, we show how the MSO characterization of all the communication
models we considered induces several decidability results for
synchronizability and bounded model-checking problems on systems of
communicating finite state machines.

A communicating finite state machine is a finite state automaton labeled with send
and receive actions; a system $\Sys$ is a finite collection of such machines.
An MSC $\msc$ is an asynchronous behavior of $\Sys$ if every process
time line of $\msc$ is accepted by its corresponding process automaton
\ifappendix
(see Appendix~\ref{app:cfsm} for a formal definition of these notions).
\fi
We write $L_{\asy}(\Sys)$ to denote the set of asynchronous behaviors of $\Sys$,
and we write $L_{\comsymb}(\Sys)$ to denote the restriction of $L_{\asy}$ to $\comsymb$ MSCs,
i.e. $L_{\comsymb}(\Sys)=L_{\asy}(\Sys)\cap\MSCclassofcom{\comsymb}$.

In general, even simple verification problems, such
as control-state reachability, are undecidable for
communicating systems~\cite{DBLP:journals/jacm/BrandZ83}, under all communication models (except
$\rsc$, which we won't consider anymore from now on).
They may become decidable if we restrict the behaviors, which motivates the following
definition of  generic \emph{bounded model-checking} problem for $\{\asy, \oneone, \co, \none, \onensymb, \nnsymb \}$. 
%
Let $\aMSCclass$ be a class of $\MSCs$s. The $\aMSCclass$-bounded model-checking problem
for a communication model $\comsymb$ is: given a system $\Sys$ and a MSO
specification $\amsoformula$, decide whether
$L_{\comsymb}(\Sys)\cap \aMSCclass \subseteq L(\amsoformula)$.
%
In the remainder, we  consider classes $\aMSCclass$ of MSCs that share the same intuition
that they only contain "almost synchronous" MSCs. So the bounded model-checking problem
corresponds to an under-approximation of the standard model-checking problem where the
system is assumed to be "almost synchronous". The question of the completeness of this under-approximaton, 
i.e. whether $L_{\comsymb}(\Sys)\subseteq \aMSCclass$, will be 
referred to as the "synchronizability problem".


Bollig~\emph{et al.}~\cite{BolligGFLLS21} introduced a general framework that allows to derive decidability results 
for the bounded model-checking and synchronizability problems
for various classes of MSCs $\aMSCclass$. The communication model is however a fixed parameter
in their framework.
In this section, we roughly manage to make this framework parametric in the communication
model, up to several technical restrictions. The first restriction is that the communication
model, combined with the bounding class $\aMSCclass$, should enforce a bounded treewidth of the
MSCs, which is not always the case. The second restriction is that a key lemma in the framework
of  Bollig~\emph{et al.} relied on the existence of "borderline violations", which was granted
by a form of prefix closure of the MSCs of a given class. However, this prefix closure property
does not hold for all communication models, and these models must be treated with specific
techniques.

\paragraph{\bf Special treewidth and bounded model-checking}
\emph{Special treewidth} (STW)
is a graph measure that somehow indicates how close
a graph is to a tree (we may also use Courcelle's classical \emph{treewidth} instead~ \cite{Courcelle10}).
This measure or similar ones are commonly employed in verification. For instance, treewidth and split-width have been used in~\cite{MadhusudanP11} and~\cite{DBLP:conf/concur/CyriacGK12,AiswaryaGK14}, respectively, to reason about graph behaviors generated by pushdown and queue systems.
%Here we apply it to reason about MSCs.
Note that an MSC is a graph where the nodes are the events and the edges are represented by the $\procrel$ and the $\lhd$ relations.

There are several ways to define the special treewidth of a graph.
We adopt the following game-based definition from~\cite{DBLP:journals/corr/abs-1904-06942},
and, to make it more concrete, reformulate it directly on MSCs instead of graphs.
Adam and Eve play a turn based "decomposition game" on an MSC $\msc = (\Events, \procrel, \lhd, \lambda)$. $\msc$
Eve starts to play and does a move, which consists in the following steps:
\begin{enumerate}
	\item marking some events of $\msc$, resulting in the \emph{marked MSC fragment} $(M, U')$, where $U' \subseteq \Events$ is the subset of marked events,
	\item removing edges whose both endpoints are marked, in such a way that the resulting MSC is disconnected (i.e. there are at least two different connected components),
	\item splitting $(M, U)$ in $(M_1, U_1)$ and $(M_2, U_2)$ such that $M$ is the disjoint (unconnected) union of $M_1$ and $M_2$
	and marked nodes are inherited.
\end{enumerate}
Once Eve does her move, it is Adam's turn. Adam simply chooses one of the two marked MSC fragments, either $(M_1, U_1)$ or $(M_2, U_2)$. Now it is again Eve's turn, and she has to do a move on the marked MSC fragment that was chosen by Adam. The game continues in alternating turns between the two players until they reach a point where all the events on the current marked MSC fragment are marked.
For $k \in \N$, we say that the game is $k$-winning for Eve if she has a strategy that allows her, independently of Adam's moves, to end the game in a way that every marked MSC fragment visited during the game has at most $k+1$ marked events. The goal of Eve is to keep $k$ as low as possible. Fig.~\ref{fig:stw-ex} shows an example of a 3-winning game for the MSC in Fig.~\ref{fig:pp_ex}.

The special treewidth of an MSC is the least $k$ such that
the associated game is $k$-winning for Eve
(see for instance~\cite{DBLP:journals/corr/abs-1904-06942}).
The set of MSCs whose special treewidth is at most $k$ is denoted by $\stwMSCs{k}$. It is easy to check that trees have a special treewidth of 1.

\begin{example}
	Let $\msc$ the MSC of the Fig.~\ref{fig:pp_ex}. In this example, we show that $\msc$ has a special treewidth of at most 3, since Eve is able to find a strategy that leads to a 3-winning game.  We use colors to mark events. Eve starts by marking 4 events. The edges whose both endpoints are marked can be removed (dotted edges in the figure) and the graph becomes disconnected. Eve then splits the graph in 2 and Adam has to choose.
	Suppose the Adam picks the subgraph with the red and yellow events already marked (top branch in the figure). Eve can mark the third event and, by doing so, the game ends.
	Suppose Adam chooses the subgraph with the blue and green events (bottom branch). Eve marks the two nodes in the bottom, removes 3 edges, and splits the graph in two. Note that one of the two subgraphs already has all events marked, so Adam zpicks the other one (top branch).
	Eve simply marks the missing event and the game ends. This is a 3-winning game for Eve since, independently of Adam's choices, we have at most 4 marked event at each step.
\end{example}
\input{img/decomposition_game}

Courcelle's theorem implies that the following problems is
decidable: given a MSO formula $\amsoformula$ and $k\geq 1$,
decide whether $\amsoformula$ holds for all MSCs $\msc\in\stwMSCs{k}$.
Therefore, a direct consequence of Courcelle's theorem and of our MSO characterization
of the communication models is that bounded-model-checking is decidable\footnote{cfr. proof in Appendix \ref{proofbmc}}.

\begin{restatable}{theorem}{thmBoundedMC}\label{thm:bounded-model-checking}
Let $\comsymb\in\{\asy, \co, \pp, \mb, \onensymb, \nnsymb, \rsc\}$ and $k\geq 1$ be fixed.
Then the following problem is decidable: given a system $\Sys$ and
a MSO specification $\amsoformula$, decide whether
$L_{\comsymb}(\Sys)\cap \stwMSCs{k}\subseteq L(\amsoformula)$.
\end{restatable}

\paragraph{\bf The synchronizability problem}

Theorem~\ref{thm:bounded-model-checking} remains true if instead of
$\stwMSCs{k}$ we bound the model-checking problem with
a class $\aMSCclass$ of MSCs that is both treewidth bounded and MSO definable.
The synchronizability problem (SP, for short) consists in deciding whether this bounded model-checking is complete,
i.e. whether all the behaviors generated by a given communicating system are included in this
class $\aMSCclass$, i.e. whether
$\cL{\Sys} \subseteq \aMSCclass$.

\begin{definition}
Let a communication model $\comsymb$ and a class $\aMSCclass$ of MSCs be fixed. The
$(\comsymb,\aMSCclass)$-synchronizability problem is defined as follows: given a
system $\Sys$, decide whether $L_{\comsymb}(\Sys)\subseteq \aMSCclass$.
\end{definition}

In \cite{BolligGFLLS21} the authors show that, for $\comsymb = \oneone$ and $\comsymb = \none$, 
the $(\comsymb,\aMSCclass)$-synchronizability problem is decidable for several classes $\aMSCclass$. 
We generalize their result to other communication models under a general assumption on the bounding class $\aMSCclass$.

\begin{restatable}{theorem}{thmsync}\label{thm:sync}
%	Fix finite sets $\Procs$ and $\Msg$.
	For any $\comsymb \in \{\asy, \oneone, \co, \none, \onensymb, \nnsymb\}$ and
	for all   class of MSCs $\aMSCclass$,
	if $\aMSCclass$ is STW-bounded and MSO-definable,
	then the $(\comsymb,\aMSCclass)$-synchronizability problem is decidable.
\end{restatable}
The proof of Theorem~\ref{thm:sync} resembles the proof of~\cite[Theorem~11]{BolligGFLLS21-long}, and the main technical argument of the existence of a "borderline violation" remains 
(see~\cite[Lemma~9]{BolligGFLLS21-long}). However, the existence of a borderline violation is more subtle to establish, because the $\onenMSCs$ and 
$\nnMSCs$ are not prefixed-closed (see Fig.~\ref{fig:onen-prefix}).
A way to solve this technical problem is to consider a more strict notion of prefix. All details of
the proof of Theorem~\ref{thm:sync} can be found in Appendix~\ref{apx:sync}.

\begin{figure}[t]
	\captionsetup[subfigure]{justification=centering}
\centering
\begin{subfigure}[t]{0.45\textwidth}\centering
	\begin{tikzpicture}[scale=1, every node/.style={transform shape}]
		\newproc{0}{p}{-2};
		\newproc{1}{q}{-2};
		\newproc{2}{r}{-2};

		\newmsgm{0}{1}{-0.7}{-0.7}{1}{0.4}{black};
		\newmsgm{0}{2}{-1.4}{-1.4}{2}{0.2}{black};

	\end{tikzpicture}
	\caption{A $\nnsymb$-MSC $\msc$.}
\end{subfigure}
% \hfill
\begin{subfigure}[t]{0.45\textwidth}\centering
	\begin{tikzpicture}[scale=1, every node/.style={transform shape}]
		\newproc{0}{p}{-2};
		\newproc{1}{q}{-2};
		\newproc{2}{r}{-2};

		\newmsgum{0}{1}{-0.7}{1}{0.4}{black};
		\newmsgm{0}{2}{-1.4}{-1.4}{2}{0.2}{black};

	\end{tikzpicture}
	\caption{A prefix of $\msc$.}
\end{subfigure}
	\caption{A $\nnsymb$-MSC and a prefix that is neither a $\onensymb$-MSC nor a $\nnsymb$-MSC.}
	\label{fig:onen-prefix}
\end{figure}

In the remainder, we investigate which combinations of $\comsymb$ and $\aMSCclass$ fit the hypotheses of this theorem.
We review the classes of weakly synchronous and weakly k-synchronous inspired
by~\cite{DBLP:conf/cav/BouajjaniEJQ18},
and the classes of existentially $k$-bounded and universally $k$-bounded MSCs~\cite{genest2004kleene}.
%
% As shown in \cite{BolligGFLLS21}, if we have a system $\Sys$ and a STW-bounded class $\aMSCclass$, then the model-checking problem\footnote{Given $\Procs$ and $\Msg$, a communicating system $\Sys$, an MSO sentence $\phi$, do we have $\cL{\Sys} \subseteq L(\phi)?$} for $\Sys$ becomes decidable if $L(S) \subseteq \aMSCclass$; this motivates the study of the synchronizability problem.
%
Fig.~\ref{fig:stw-bound} summarizes the decidability results of the
$(\comsymb,\aMSCclass)$-synchronizability problem for each combination of $\comsymb$ and $\aMSCclass$ 
we will consider in the next sections.

\input{img/stw_bound}


%%%%%% COPY-PASTE from report

% \subsection{Semantics of causal ordering}

% \newcommand{\buffers}{\vv{\text{Buf}}}
% \newcommand{\clocks}{\vv{\text{Vec}}}
% \begin{definition}
% 	Given a system $\System = (Loc_p, \delta_p, \ell^0_p)_{p\in\procSet}$ with $n$ processes, a \emph{configuration} is a tuple $(\vv{\ell},\buffers,\clocks)$, where $\vv{\ell}=(\ell_p)_{p \in \procSet}$ represents the global state of the system, $\buffers=(b_p)_{p \in \procSet}$ is a vector of buffers, with each $b_p \in \Msg^*$ representing the content of the buffer of process $p$, and $\clocks=(v_p)_{p \in \procSet}$ is a vector of Mattern-Fidge logical clocks, where each $v_p = (time_i)_{i \in \procSet}$ represents the content of the logical vector clock of process $p$.
% \end{definition}

\paragraph{\bf Weakly synchronous MSCs}
We first introduce the class of weakly synchronous MSCs. 
This is a generalization of $k$-synchronous MSCs studied 
in~\cite{DBLP:conf/cav/BouajjaniEJQ18}. 
We say an MSC is weakly synchronous if it can be chunked into \emph{exchanges}, where an exchange is an MSC that allows one to schedule all 
send events before all receive events. 

\begin{definition}[Exchange]\label{def:weak-synchr}
Let $\msc = (\Events,\procrel,\lhd,\lambda)$ be an MSC.
We say that $\msc$ is an \emph{exchange} if
$\SendEv{\msc}$ is
a ${\happensbefore}$-downward-closed set.
\end{definition}

\begin{wrapfigure}[12]{r}{0pt}
	\begin{tikzpicture}[>=stealth,node distance=3.4cm,shorten >=1pt,semithick]

	\begin{scope}[scale = 1]
	  %MACHINES
	  \draw (0,1.25) node{$q$} ;
	  \draw (1.6,1.25) node{$r$} ;
	  \draw (-1.25,1.25) node{$p$} ;
	  \draw (0,1) -- (0,-3.1) ;
	  \draw (1.6,1) -- (1.6,-3.1);
	  \draw (-1.25,1) -- (-1.25,-3.1);

	  %MESSAGES
	  \draw[>=latex,->, dashed] (-1.25, 0.5) -- (-1.25*0.1, 0.5) node[ above, midway] {$\amessage_1$};
	  \draw[>=latex,->] (0, -.2) -- (-1.25, -.2) node[ above, midway] {$\amessage_2$};


	  \draw[>=latex,->] (0, -0.4) -- (1.6, -1.75) node[pos=0.1, sloped, above] {$\amessage_3$};
	  \draw[>=latex,->] (0, -1.1) -- (1.6, -2.45) node[pos=0.1, sloped, above] {$\amessage_3$}; %{$\amessage_1'$};
	  %\draw[>=latex,->, dashed] (0, -2.5) -- (1.25, -3.25) node[pos=0.55, sloped, above] {$\amessage_1''$};

	  \draw[>=latex,->] (1.6, -0.4) -- (0, -1.75) node[pos=0.1, sloped, above] {$\amessage_4$};
	  \draw[>=latex,->] (1.6, -1.1) -- (0, -2.45) node[pos=0.1, sloped, above] {$\amessage_4$}; %{$\amessage_2'$};
	  %\node[rotate = 90, left]at (1.13, -0.65) {$\cdots$};
	  %\node[rotate = -90, right]at (0.1, -0.65) {$\cdots$};

	  \draw[>=latex,->] (1.6, -2.6) -- (0, -2.6) node[ below, midway] {$\amessage_5$};


	\end{scope}

	\end{tikzpicture}
	\caption{$\mscW$}
	\label{fig:msc_W}
\end{wrapfigure}

In other words, an exchange is an MSC $\msc$ where no send event depends on a receive event. 
If that is the case, we can find a linearization for $\msc$ where all the send events are executed before the 
receive events. Remember that $\msc_1\cdot\msc_2$ denote the vertical concatenation of MSCs (see 
Section~\ref{sec:MSC}).

\begin{definition}[Weakly synchronous]\label{def:weaksync-new}
	We say that $\msc \in \MSCs$ is
	\emph{weakly synchronous} if it is of the form
	$\msc = \msc_1 \cdot \msc_2 \cdots \msc_n$
	such that every $\msc_i$ is an exchange.
\end{definition}

\begin{example}\label{example:msc_W}
	Consider the MSC $\mscW$ in Fig.~\ref{fig:msc_W}. It is is weakly synchronous. Indeed, $\amessage_1$, $\amessage_2$, and $\amessage_5$ are independent and can be put alone in an exchange. Repetitions of $\amessage_3$ and $\amessage_4$ are interleaved, but they constitute an exchange, as  all sends can be scheduled before all the receptions.
\end{example}

In \cite{BolligGFLLS21} it is shown that, for the class of weakly synchronous MSCs, 
the synchronizability problem is undecidable for $\comsymb = \oneone$, but decidable for $\comsymb = \oneone$.
Here we investigate the decidability of weak synchronizability for the other 
communication models. We first show that weak synchronizability 
is undecidable for causally ordered communication. 
The proof is an adaptation of the one given in~\cite[Theorem~20]{BolligGFLLS21-long} for the $\oneone$ case (cfr. Appendix \ref{apx:prop-co-weak-sync}).
\begin{restatable}{proposition}{propCoWeakSync}
\label{prop:co-weaksync}
	The following problem is undecidable:
	given a communicating system $\System$,
	is every MSC in $\coL{\System}$ weakly synchronous?
\end{restatable}

For $\onensymb$ and $\nn$, on the other hand, weak synchronizability is decidable. 

\begin{proposition}\label{thm:weak-sync}
	Let $\comsymb \in \{$$\onensymb, $ $\nnsymb\}$.
	The following problem is decidable:
	given a communicating system $\System$,
	is every MSC in $\cL{\System}$ weakly synchronous?
\end{proposition}

\begin{proof}
	% The claim follows from Theorem~\ref{thm:sync}. We only detail the proof
	% for the $\onensymb$ case (the other is identical). To apply Theorem~\ref{thm:sync}, we need to check that
	% (1) the class $\aMSCclass_{ws}$ of weakly synchronous MSCs is MSO definable, and (2)
	% $\aMSCclass_{ws}\cap \onenMSCs$ is STW-bounded. 
	% (1) has been proved by Bollig~\emph{et al}~\cite{BolligGFLLS21}. For (2),
	% it follows from the fact that $\onenMSCs\subseteq \MSCclassofcom{\mb}$ (Prop~\ref{prop:onen_mb_unmatched}) and the fact $\aMSCclass_{ws}\cap \MSCclassofcom{\mb}$ is STW-bounded 
	% (see~\cite{BolligGFLLS21}).

	% \etienne{Better cite CONCUR paper to say where to look for the proof (cite[Thm truc]\{paper bidule\}).}
	We will consider $\comsymb = \onensymb$; the proof for $\comsymb = \nnsymb$ is similar. We would like to know if every MSC in $\onenL{\System}$ is in the class of weakly synchronous MSCs. Since every MSC in $\onenL{\System}$ is a $\onensymb$-MSC, we can equivalently restrict the problem to the class of weakly synchronous MSCs that are also $\onensymb$-MSCs. Let $\aMSCclass$ be the class of $\onensymb$ weakly synchronous MSCs; we show that $\aMSCclass$ is MSO-definable and STW-bounded, which implies the decidability of $SP$ for Theorem~\ref{thm:sync}. The class of weakly synchronous MSCs was shown to be MSO-definable in \cite{BolligGFLLS21}; to be precise, their characterization is for $\oneone$ weakly synchronous MSCs (since their definition of MSC is equivalent to our definition of $\pp$-MSC), but it also works for (asynchronous) weakly synchronous MSCs. We showed in Section~\ref{sec:MSO} that $\onenMSCs$ is MSO-definable; it follows that the class of $\onensymb$ weakly synchronous MSCs is also MSO-definable (we just take the conjuction of the the two formulas). The class of $\none$ weakly synchronous MSCs was shown to be STW-bounded in \cite{BolligGFLLS21}, and since $\onenMSCs \subset \mbMSCs$, we also have that the class of $\none$ weakly synchronous MSCs has a bounded special treewidth. 
\end{proof}

\paragraph{\bf Weakly \texorpdfstring{$k$}{k}-synchronous MSCs}

%The undecidability result for some of the communication models motivates the study of other classes. 
We consider now weakly $k$-synchronous MSCs (\cite{BolligGFLLS21}), which are the weakly synchronous MSCs such that the number of messages sent per exchange is at most $k$.


\begin{definition}[$k$-exchange]\label{def:weak-k-synchr}
Let $\msc = (\Events,\procrel,\lhd,\lambda)$ be an MSC
and $k \in \N$.
 $\msc$ is a $k$-\emph{exchange} if
$\msc$ is an exchange and $\cardinalof{\SendEv{\msc}} \le k$.
\end{definition}


\begin{definition}[Weakly $k$-synchronous]\label{def:weaksync}
Let $k \in \N$.
 $\msc \in \MSCs$ is
weakly $k$-synchronous if it is of the form
$\msc = \msc_1 \cdot \msc_2 \cdots \msc_n$
such that every $\msc_i$ is a $k$-exchange.
\end{definition}


\begin{example}
MSC $\mscweakSexist$ in Fig.~\ref{fig:msc_weak_S_exist} is weakly $1$-synchronous, as it can be
decomposed  into three \kE{1}s (the decomposition is depicted by the
horizontal dashed lines).
\end{example}

\begin{wrapfigure}[10]{r}{0pt}
	\begin{tikzpicture}[>=stealth,node distance=3.4cm,shorten >=1pt, semithick]
	\begin{scope}[scale=1]
	  %MACHINES
	  \draw (0,0) node{$p$} ;
	  \draw (1,0) node{$q$} ;
	  \draw (2,0) node{$r$} ;
	  \draw (0,-0.25) -- (0,-3.1) ;
	  \draw (1,-0.25) -- (1,-3.1);
	  \draw (2, -0.25) -- (2, -3.1) ;
	  %MESSAGES
	  \draw[>=latex,->, dashed] (0,-0.75) -- (0.9, -0.75) node[midway,above]{$\amessage_1$};

	  \draw[>=latex,->] (1, -1.75) -- (0, -1.75) node[midway, above] {$\amessage_2$};
	  %\draw (0.5,-1.7) node{$\cdots$};
	  %\draw[>=latex,->] (1, -2.25) -- (0, -2.25) node[midway, above] {$\amessage_2$};

	  \draw[>=latex,->] (2,-2.75) -- (1,-2.75) node[midway, above] {$\amessage_3$};
	%\end{scope}
	  \draw[dashed] (-0.5,-1.25) -- (2.5,-1.25) ;
	  \draw[dashed] (-0.5,-2.25) -- (2.5,-2.25) ;
	\end{scope}
	\end{tikzpicture}
	\caption{$\mscweakSexist$}
	\label{fig:msc_weak_S_exist}
\end{wrapfigure}

As for weakly synchronous MSCs, the class of weakly $k$-synchronous MSCs was already shown to be MSO-definable and STW-bounded in \cite{BolligGFLLS21}, and these results still hold even for our definition of MSC. A direct application of Theorem~\ref{thm:sync} shows that, for weakly $k$-synchronous MSCs, $SP$ is decidable for all communication models.

\begin{proposition}\label{thm:weak-k-sync}
	Let $\comsymb \in \{$$\asy, $ $\oneone, $ $\co, $ $\none, $ $\onensymb, $ $\nnsymb\}$.
	The following problem is decidable:
	given a communicating system $\System$,
	is every MSC in $\cL{\System}$ weakly $k$-synchronous?
\end{proposition}
\begin{proof}
	The class $\aMSCclass$ of weakly $k$-synchronous MSCs is MSO-definable and STW-bounded, therefore the
	result follows from Theorem~\ref{thm:sync}.
\end{proof}

\paragraph{\bf Existentially bounded MSCs}

We move now to existentially $k$-bounded MSCs, first introduced by Lohrey and Muschol~\cite{DBLP:conf/fossacs/LohreyM02}, that form a relevant class of MSC for extending the
B\"uchi-Elgot-Trakhthenbrot theorem from words to MSCs \cite{genest2004kleene,GKM07}. 
Existentially bounded MSCs represent the behavior of systems that can be realized with bounded channels. 
We stick to the original definition of Lohrey and Muscholl of $k$-bounded MSCs, where $k$
represents the bound on the number of messages in transit from a given process to another, so that globally
there may be up to $k\cardinalof{\procSet}^2$ in transit.\footnote{It may look
surprising in our general context to count messages in transit this way, but it can be shown that, up to picking
a different value for the bound $k$, it is equivalent to the possibly more
intuitive definition based on counting all messages in transit, independently of their sender and receiver.}
Intuitively, we say that an MSC is existentially $k$-bounded if it admits a linearization where, at any moment in time, and for all pair of processes $p,q$, there are no more than $k$ messages in transit from $p$ to $q$. Such a linearization will be referred to as a $k$-\emph{bounded linearization}. We give formal definitions below.

\begin{wrapfigure}[11]{r}{0pt}
	\begin{tikzpicture}[>=stealth,node distance=3.4cm,shorten >=1pt,
		semithick]
	  \begin{scope}[scale = 1]
		% \draw (1.25, -4.75) node{\textbf{(a)}};
		% \draw (4.5, -4.75) node{\textbf(b)};

		%MACHINES
		\draw (0,-0.1) node{$p$} ;
		\draw (1.25,-0.1) node{$q$} ;
		\draw (2.5,-0.1) node{$r$} ;
		\draw (2.5, -0.35) -- (2.5, -3.4) ;
		\draw (0,-0.35) -- (0,-3.4) ;
		\draw (1.25,-0.35) -- (1.25,-3.4);
		%MESSAGES

		\draw[>=latex,->] (0, -0.5) -- (1.25, -1.25) node[pos=0.4, sloped, above] {$\amessage_1$};
		\draw[>=latex,->] (0, -1.5) -- (1.25, -2.25) node[pos=0.55, sloped, above] {$\amessage_1$};
		\draw[>=latex,->, dashed] (0, -2.45) -- (1.25*0.9, -3.2) node[pos=0.65, sloped, above] {$\amessage_1$};

		\draw[>=latex,->] (1.25, -0.75) -- (0, -2) node[pos=0.5, sloped, above] {$\amessage_2$};
		\draw[>=latex,->] (1.25, -1.75) -- (0, -3) node[pos=0.5, sloped, above] {$\amessage_2$};


		\draw[>=latex,->] (1.25, -1) -- (2.5, -1) node[midway, above] {$\amessage_3$};
		\draw[>=latex,->] (1.25, -1.5) -- (2.5, -1.5) node[midway, above] {$\amessage_3$};
		\draw[>=latex,->] (1.25, -2.5) -- (2.5, -2.5) node[midway, above] {$\amessage_3$};

		%\draw (0.6, -3.35) node{$\cdots$};
		%\draw (1.9, -3.35) node{$\cdots$};
	  \end{scope}
			% \begin{scope}[shift = {(3,0)}, scale = 0.8]
			%   % \draw (0.5, -4) node{\textbf{(b)}};
			%   %MACHINES
			%   \draw (0,0) node{$p$} ;
			%   \draw (1,0) node{$q$} ;
			%   \draw (0,-0.25) -- (0,-3.5) ;
			%   \draw (1,-0.25) -- (1,-3.5);
			%   %MESSAGES
			%
			%    \draw[>=latex,->] (0, -0.75) -- (1, -0.75) node[midway, above] {$\amessage_1$};
			%    \draw[>=latex,->] (1, -1.5) -- (0, -1.5) node[midway, above] {$\amessage_2$};
			%    \draw[>=latex,->] (0, -2.25) -- (1, -2.25) node[midway, above] {$\amessage_1$};
			%    \draw[>=latex,->] (1, -3) -- (0, -3) node[midway, above] {$\amessage_2$};
			%
			%
			%   % \draw (0.5, -3.25) node{$\cdots$};
			% \end{scope}
	\end{tikzpicture}
	\caption{$\mscexist$}
	\label{fig:msc_exist}
\end{wrapfigure}

\begin{definition}\label{def:lin_k_bounded}
	Let $\msc = (\Events,\procrel,\lhd,\lambda) \in \MSCs$ and $k \in \N$.
	A linearization $\linrel$ of $\msc$ is called
	$k$-\emph{bounded} if, for all $e \in \SendEv{\msc}$, with $\lambda(e) = \sact{p}{q}{\msg}$, we have
	\[
	\sametype{e}{\pqsAct{p}{q}}{\linrel} - \sametype{e}{\pqrAct{p}{q}}{\linrel} \le k
	\]
\end{definition}
\noindent where $\sametype{e}{A}{\rel} = |\{f \in \Events \mid (f,e) \in \rel$ and $\lambda(f) \in A\}|$.
For instance, $\sametype{e}{\pqsAct{p}{q}}{\linrel}$ denotes the number of send events from $p$ to $q$ that occured before $e$ according to $\linrel$. Note that, since $\linrel$ in reflexive, $e$ itself is counted in $\sametype{e}{\pqsAct{p}{q}}{\linrel}$.

\begin{definition}[Existentially bounded MSC]\label{def:ek_bounded_msc}
	Let $\msc = (\Events, \rightarrow, \lhd, \lambda) \in \asMSCs$ and $k \in \mathbb{N}$.  $\msc$ is \emph{existentially $k$-bounded} ($\exists k$-bounded) if it has a $k$-bounded linearization.
\end{definition}
We now look at the definitions of $\oneone$ $\exists k$-bounded MSCs and causally ordered $\exists k$-bounded, which are quite straightforward.

\begin{example}
MSC $\mscexist$ in Fig.~\ref{fig:msc_exist}
is existentially $1$-bounded, as witnessed by the linearization $!2\;!1\;!3\;?3\;?1\;!1\;?2\;!3\;?3 \ldots$
Note that $\mscexist$ is not weakly synchronous as we cannot divide it into exchanges.
\end{example}

\begin{definition}
	An MSC $\msc$ is \emph{$\oneone$ existentially $k$-bounded} ($\oneone$-$\exists k$-bounded) if it is a $\pp$-MSC and it is also existentially $k$-bounded.
\end{definition}
\begin{definition}
	An MSC $\msc$ is \emph{causally orderered existentially $k$-bounded} ($\cosymb$-$\exists k$-bounded) if it is a causally ordered MSC and it is also existentially $k$-bounded.
\end{definition}

When moving on to the other communication models, the definitions are not as straightforward. For instance, the definition of $\none$ $\exists k$-bounded MSC should require that there exists a $k$-bounded linearization that is also a $\mb$-linearization, not just any linearization. Recall that an MSC is a $\mb$-MSC if it has at least one $\mb$-linearization, which represents a sequence of events that can be executed by a $\none$ system. Following this intuition, we want one of these $\mb$-linearizations to be $k$-bounded, not just any linearization.

\begin{definition}
	An MSC $\msc$ is \emph{$\none$ existentially $k$-bounded} ($\none$-$\exists k$-bounded) if it has a $k$-bounded $\mb$-linearization.
\end{definition}
% \davide{This paragraph depends on how we choose to formally define the mailbox communication model... we could go for a (i) single incoming channel, or (ii) just an enforcing of the delivery of messages by the transport layer.}
% It should be noted that, for a $k$-bounded mailbox linearization, it is not necessarily true that at any time we have at most $k$ messages in each channel. Recall that in the mailbox communication architecture every process has a single incoming channel, but the Definition~\ref{def:lin_k_bounded} of $k$-bounded linearization considers the number of pending messages between each pair $(p,q)$ of processes. Let $n$ be the number of processes. We can say that, for a $k$-bounded mailbox linearization, we have at most $k(n-1)$ messages in each channel at any moment (because each process can have at most $k$ pending messages coming from any of the other $n-1$ processes).
% \davide{An example would be nice.}

\begin{definition}
	An MSC $\msc$ is \emph{$\onensymb$ existentially $k$-bounded} (onen-$\exists k$-bounded) if it has a $k$-bounded $\onensymb$-linearization.
\end{definition}

\begin{definition}
	An MSC $\msc$ is \emph{$\nnsymb$ existentially $k$-bounded} (nn-$\exists k$-bounded) if it has a $k$-bounded $\nnsymb$-linearization.
\end{definition}

We show that each of the $\exists k$-bounded classes of MSCs presented so far is MSO-definable and STW-bounded. We then derive the decidability of $SP$ in a similar way to what we did in the proof of Proposition~\ref{thm:weak-sync} for weakly synchronous MSCs.

\paragraph*{MSO-definability}

We start by investigating the MSO-definability of all the variants of $\exists k$-bounded MSCs, we begin with the most general class of $\exists k$-bounded MSCs.
Following the approach taken in \cite{DBLP:conf/fossacs/LohreyM02}, we introduce a binary relation $\relb$ ($\linrel_b$ in their work) associated with a given bound $k$ and an MSC $\msc$. Let $k \ge 1$ and $\msc$ be a fixed MSC. We have $r \relb s$ if, for some $i \ge 1$ and some channel ($p$,$q$)\footnote{Recall that ($p,\,q$) is a channel where messages are sent by $p$ and received by $q$.}:
\begin{enumerate}%\itemsep=0.5ex
	\item $r$ is the $i$-th receive event (executed by $q$).
	\item $s$ is the ($i+k$)-th send event (executed by $p$).
\end{enumerate}

\begin{wrapfigure}[11]{r}{0.2\textwidth}
	\centering
	\begin{tikzpicture}[>=stealth,node distance=3.4cm,shorten >=1pt,semithick]
	  \begin{scope}[scale = 1]
		\newproc{0}{p}{-2.8};
		\newproc{2}{q}{-2.8};
	
		\newmsgm{0}{2}{-.6}{-.6}{1}{0.3}{black};
		\newmsgm{0}{2}{-1.3}{-1.3}{2}{0.3}{black};
		\newmsgm{0}{2}{-2.1}{-2.1}{3}{0.3}{black};
	  \end{scope}

	\end{tikzpicture}
	\caption{$\msc_4$.}
	\label{fig:bounded_lin_ex}
\end{wrapfigure}

For any two events $s$ and $r$ such that $r \relb s$, every linearization of $\msc$ in which $r$ is executed after $s$ cannot be $k$-bounded. Intuitively, we can read $r \relb s$ as "$r$ has to be executed before $s$ in a $k$-bounded linearization". A linearization $\linrel$ that respects $\relb$ (i.e. $\relb \,\subseteq\, \linrel$) is $k$-bounded.

\begin{example}
  Consider MSC $\msc_4$ in Fig~\ref{fig:bounded_lin_ex}. Suppose we want to look for a $2$-bounded linearization. For $k=2$, we have $?1 \relbk{2} !3$; if we find a valid linearization that respect the $\relbk{2}$ relation, then it is $2$-bounded, e.g., $!1\;!2\;?1\;!3\;?2\;?3$ (note that $?1$ is executed before $!3$). On the other hand, the linearization $!1\;!2\;!3\;?1\;?2\;?3$ is not 2-bounded, since $?1$ is executed after $!3$.
\end{example}  


In \cite{DBLP:conf/fossacs/LohreyM02} it was shown that an MSC is $\exists k$-bounded if and only if the relation $\happensbefore \cup \relb$ is acyclic. Since $\happensbefore$ and acyclicity are both MSO-definable, it suffices to find an MSO formula that defines $\relb$ to claim the MSO-definability of $\exists k$-bounded MSCs. Unfortunately, $\relb$ is not MSO-definable because MSO logic cannot be used to "count" for an arbitrary $i$. For this reason, we introduce a similar MSO-definable binary relation $\relbAsy$, and we show that an MSC $\msc$ is $\exists k$-bounded MSC iff $\happensbefore \cup \relbAsy$ is acyclic and another condition holds. Let $k \ge 1$ and $\msc$ be a fixed MSC; we have $r \relbAsy s$ if, for some $i \ge 1$ and some channel ($p$,$q$):
\begin{itemize}%\itemsep=0.5ex
	\item There are $k+1$ send events $(s_1, \dots, s_k, s)$, where at least one is matched, such that $s_1 \procrel^+ \dots \procrel^+ s_k \procrel^+ s$.
 	\item $r$ is the first receive event for the matched send events among $s_1, \dots, s_k, s$.
\end{itemize}

\begin{proposition}\label{prop:asy_ek_def_alt}
	An MSC $\msc$ is $\exists k$-bounded if and only if $\happensbefore \cup \relbAsy$ is acyclic and, for each channel ($p$,$q$), there are at most $k$ unmatched send events.
\end{proposition}
\begin{proof}
	($\Rightarrow$) Suppose $\msc$ is $\exists k$-bounded, i.e. it has at least one $k$-bounded linearization $\linrel$. Firstly, notice that every MSC that has more than $k$ unmatched send events in any channel cannot be an $\exists k$-bounded MSC. We know that $\happensbefore \;\subseteq\; \linrel$, and we will show  that also $\relbAsy \;\subseteq\; \linrel$. This implies that $\happensbefore \cup \relbAsy$ is acyclic, otherwise we would not be able to find a linearization $\linrel$ that respects both $\happensbefore$ and $\relbAsy$. Suppose, by contradiction, that $\relbAsy \;\nsubseteq\; \linrel$, i.e. there are two events $r$ and $s$ such that $r \relbAsy s$ and $s \linrel r$. By definition of $\relbAsy$, there are $k$ send events in a channel ($p$,$q$) that are executed before $s$, and whose respective receive events happens after $r$. If $s$ is executed before $r$ in the linearization, there will be $k+1$ messages in channel (i.e. $\linrel$ is not $k$-bounded). We reached a contradiction, hence $\relbAsy \;\subseteq\; \linrel$ and $\happensbefore \cup \relbAsy$ is acyclic.
	
	($\Leftarrow$) Suppose $\happensbefore \cup \relbAsy$ is acyclic and, for each channel ($p$,$q$), there are at most $k$ unmatched send events. If $\happensbefore \cup \relbAsy$ is acyclic, we are able to find one linearization $\linrel$ for the partial order $(\happensbefore \cup \relbAsy)^\ast$. We show that this linearization is $k$-bounded. By contradiction, suppose $\linrel$ is not $k$-bounded, i.e. we are able to find $k+1$ send events $s_1 \procrel^+ \dots \procrel^+ s_k \procrel^+ s$ on a channel ($p$,$q$), such that $s$ is executed before any of the respective receive events takes place. Two cases:
	\begin{itemize}
		\item Suppose all the $k+1$ send events are unmatched. This is impossible, since we supposed that there are at most $k$ unmatched send events for any channel.
		\item Suppose there is at least one matched send event between the $k+1$ sends. Let the first matched send event be $s_i$ and let $r$ be the receive event that is executed first among the receive events for these $k+1$ sends. By hypothesis, $s \linrel r$. However, according to the definition of $\relbAsy$, we must have $r \relbAsy s$. We reached a contradiction, since we cannot have that $s$ happens before $r$ in a linearization for the partial order $(\happensbefore \cup \relbAsy)^\ast$, if $r \relbAsy s$.
	\end{itemize}
\end{proof}

\noindent According to Proposition~\ref{prop:asy_ek_def_alt}, we can write the MSO formula the defines $\exists k$-bounded MSCs as
\[
\Psi_{\exists k}=
acyclic(\happensbefore \cup \relbAsy) \;\wedge\;
\neg \left(
	\exists s_1 \dots s_{k+1}. s_1 \procrel^+ \dots \procrel^+ s_{k+1} \;\wedge \;
	allSends\_pq(k+1) \wedge allUnm
\right)
\]
\[
allSends\_pq (t) =
\bigvee_{\substack{p \in \Procs, q \in \Procs}}\;
\bigwedge_{s \in {s_1, ..., s_{t}}}\;
\bigvee_{a \in \pqsAct{p}{q}}
(\lambda(s) = a)
\]
\[
allUnm = \bigwedge_{s \in {s_1, ..., s_{k+1}}}(\neg \mathit{matched}(s))
\]
where $acyclic(\happensbefore \cup \relbAsy)$ is an MSO formula that checks the acyclicity of $\happensbefore \cup \relbAsy$, and the $\relbAsy$ relation can be defined as
\[
r \relbAsy s= \exists s_1 \dots s_{k+1}. \left(
\begin{array}{rl}
	& s_1 \procrel^+ \dots \procrel^+ s_{k+1} \;\wedge\;
	allSends\_p\_q(k+1) \;\wedge\; \\
	& \exists r. (\bigvee_{s \in {s_1, ..., s_{k+1}}}s \lhd r) \;\wedge\;
	\bigwedge_{e \in {s_1, ..., s_{k+1}}}(\exists f.e \lhd f \implies r \procrel^* f) \\
\end{array}
\right)
\]

\medskip

It follows that, given $k \in \N$, the set of existentially $k$-bounded MSCs is MSO-definable. Causally ordered and $\oneone$ existentially $k$-bounded MSCs are clearly MSO-definable by definition, since we already showed that $\pp$-MSCs, causally ordered MSCs, and existentially $k$-bounded MSCs are all MSO-definable. Recall that we introduced the $\relbAsy$ relation because the $\relb$ relation introduced in \cite{DBLP:conf/fossacs/LohreyM02} was not MSO-definable for asynchronous communication. However, when considering $\oneone$ communication but also all of the other communication models, because of the hierarchy shown in Section~\ref{sec:hierarchy}, $\relb$ becomes MSO-definable; the FIFO behavior ensures that, for any channel $(p,q)$, the $i$-th matched send event of $p$ matches with the $i$-th receive event of $q$. This allows us to define $r \relb s$ as:
\[
r \relb s=\exists s_1. \dots \exists s_k.\left(
allSends\_p\_q(k)
\;\wedge\; s_1\procrel s_2\procrel\dots
\procrel s_k\procrel s
\;\wedge\; s_1 \lhd r
\right)
\]
Recall that an MSC $\msc$ is $\none$-$\exists k$-bounded if it has a linearization that is both $\none$ and $\exists k$-bounded. A linearization $\linrel$ is $\none$ if $\msc$ is $\none$ and $\linrel$ is a linear extension of the partial order $\mbpartial$, i.e. $\mbpartial \;\subseteq\; \linrel$. A linearization $\linrel$ is $\exists k$-bounded if $\relb \;\subseteq\; \linrel$. It follows that a linearization $\relb$ is $\none$-$\exists k$-bounded if $(\mbpartial \cup \relb) \;\subseteq\; \linrel$. Such a linerization exists only if $\mbpartial \cup \relb$ is acyclic. If $\mbpartial \cup \relb$ is acyclic, its transitive closure always exists and it is a partial order, hence we are always able to find a linear extension. The characterization for $\onensymb$-$\exists k$-bounded MSCs and $\nnsymb$-$\exists k$-bounded is very similar. Summing up:

\begin{proposition}\label{prop:ek-mso}
	An MSC $\msc$ is $\none$-$\exists k$-bounded iff the relation $\mbpartial \cup \relb$ is acyclic.\\
	An MSC $\msc$ is onen-$\exists k$-bounded iff the relation $\onenpartial \cup \relb$ is acyclic.\\
	An MSC $\msc$ is nn-$\exists k$-bounded iff the relation $\nnbowtie \cup \relb$ is acyclic.
\end{proposition}

The MSO-definability of all the variants of $\exists$k-bounded MSCs directly follows from Proposition~\ref{prop:ek-mso}, since all of these relations were shown to be MSO-definable (Section \ref{sec:MSO}).

\paragraph*{Special treewidth}

In \cite[Lemma 5.37]{DBLP:journals/corr/abs-1904-06942} it was shown that the special treewidth of existentially $k$-bounded MSCs is bounded by $k\,|\Procs|^2$, for $k \ge 1$. Actually, STW-boundness was shown for the more general class of Concurrent Behaviours with Matching ($\mathsf{CBM}$), but the result is still valid since $\asMSCs \subset \mathsf{CBM}$. The special treewidth of the other classes of $\exists k$-bounded MSCs is also bounded, since they are clearly subclasses of $\exists k$-bounded MSCs.

\paragraph{\bf Universally bounded MSCs}

An MSC is existentially $k$-bounded if it has a $k$-bounded linearization. An MSC is universally $k$-bounded MSCs if all of its linearizations are $k$-bounded, hence the name "universally". This class of MSCs was also introduced in \cite{DBLP:conf/fossacs/LohreyM02}.

\begin{definition}[Universally bounded MSC]\label{def:uk_bounded_msc}
	Let $\msc = (\Events, \rightarrow, \lhd, \lambda) \in \asMSCs$ and $k \in \mathbb{N}$. $\msc$ is \emph{universally $k$-bounded} ($\forall k$-bounded) if all of its linearizations are $k$-bounded.
\end{definition}
\begin{definition}
	An MSC $\msc$ is \emph{\pp universally $k$-bounded} (\pp-$\forall k$-bounded) if it is a $\pp$-MSC and it is also universally $k$-bounded.
\end{definition}
\begin{definition}
	An MSC $\msc$ is \emph{causally orderered universally $k$-bounded} ($\cosymb$-$\forall k$-bounded) if it is a causally ordered MSC and it is also universally $k$-bounded.
\end{definition}

As for the existential case, the definitions for the other communication models are not as straightforward. For instance, the definition of $\none$ $\forall k$-bounded MSC should require that all the $\mb$-linearizations of the MSC are $k$-bounded, but we say nothing about linearizations that are not $\none$. The same goes for the $\onen$ and $\nn$ communication models.

\begin{definition}
	An MSC $\msc$ is \emph{mailbox universally $k$-bounded} (mb-$\forall k$-bounded) if it is a mailbox MSC and all of its mailbox linearizations are $k$-bounded.
\end{definition}
\begin{definition}
	An MSC $\msc$ is \emph{$\onensymb$ universally $k$-bounded} ($\onensymb$-$\forall k$-bounded) if it is a $\onensymb$-MSC and all of its $\onensymb$-linearizations are $k$-bounded.
\end{definition}

% \subsubsection{Hierarchy}

% \davidequestion{I think that this section, albeit interesting, might be removed...}
% In this section we will investigate the relations between the various classes of universally $k$-bounded MSCs that we introduced. From their definition, it is quite straightforward to see that $\coUk \subseteq \ppUk \subseteq \asUk$. The set of mailbox universally $k$-bounded MSCs, however, does not fit in this hierarchy. Recall that an MSC is mb-$\forall k$-bounded if all of its mailbox linearizations are $k$-bounded, but the definition does not say anything about non-mailbox linearizations. It can be the case that an MSC has a bound $k$ for its mailbox linearizations, but a higher bound $k'$ for non-mailbox linearizations. Fig.~\ref{fig:mb_uk} shows an MSC $\msc$ which is mb-$\forall 1$-bounded, but $\forall 2$-bounded. According to the mailbox semantics, a mailbox linearization of $\msc$ has to respect the order $!m_1 \mbrel\, !m_3 \mbrel\, !m_4$. Note that all mailbox linearizations are $1$-bounded, but we are able to find a non-mailbox linearization that is 2-bounded, such as $!m_1 \linrel\, !m_4 \linrel\, ?m_1 \linrel\, !m_2 \linrel\, ?m_2 \linrel\, !m_3 \linrel\, !m_4 \linrel\, ?m_3 \linrel\, ?m_4$.

% \begin{figure}[h]
% \begin{center}
% \begin{tikzpicture}
% 	\newproc{0}{p}{-1.9};
% 	\newproc{1}{q}{-1.9};
% 	\newproc{2}{r}{-1.9};

% 	\newmsgml{0}{1}{-0.5}{1}{0.5}{black};
% 	\newmsgml{1}{2}{-0.7}{2}{0.5}{black};
% 	\newmsgml{2}{1}{-1.2}{3}{0.5}{black};
% 	\newmsgml{0}{1}{-1.4}{4}{0.5}{black};
% \end{tikzpicture}
% \caption{Example of MSC which is mailbox universally 1-bounded, but not universally 1-bounded (it is universally 2-bounded).}
% \label{fig:mb_uk}
% \end{center}
% \end{figure}

% For a given $k \in \N$, Fig~\ref{fig:uk_hierarchy} gives a visual representation of how the diffent variants of universally $k$-bounded MSCs are related.

% \begin{figure}[h]
% 	\centering
% 	\includegraphics[width=8cm]{uni_k_hierarchy.png}
% 	\caption{The relation between different variants of universally $k$-bounded MSCs, given a $k \in \N$.}
% 	\label{fig:uk_hierarchy}
% \end{figure}

\paragraph*{MSO-definability}

In this section, we will investigate the MSO-definability of all the variants of universally $k$-bounded MSCs that we discussed.
In \cite{DBLP:conf/fossacs/LohreyM02}, it is shown that an MSC $\msc$ is universally $k$-bounded if and only if $\relb \;\subseteq\; \happensbefore$. In other words, $r \relb s \Rightarrow r \happensbefore s$ for any two events $r$ and $s$. This is equivalent to saying that every linearization $\linrel$ of $\msc$ respects the $\relb$ relation, since $\relb \;\subseteq\; \happensbefore \;\subseteq\; \linrel$. We already saw that $\relb$ is not MSO-definable when communication is asynchronous, hence we will use the $\relbAsy$ relation to give the following alternative characterization of universally $k$-bounded MSCs.

\begin{proposition}
	An MSC $\msc$ is $\forall k$-bounded if and only if $\relbAsy \;\subseteq\; \happensbefore$ and, for each channel ($p$,$q$), there are at most $k$ unmatched send events.
\end{proposition}
\begin{proof}
	($\Rightarrow$) Suppose $\msc$ is $\forall k$-bounded, which by definition means that all of its linearizations are $k$-bounded. Firstly, notice that every MSC that has more than $k$ unmatched send events in any channel cannot be an $\forall k$-bounded MSC (not even $\exists k$-bounded). By contradiction, suppose that $\relbAsy \;\nsubseteq\; \happensbefore$, i.e. there are two events $r$ and $s$ such that $r \relbAsy s$ and $r \nothappensbefore s$. If $r \nothappensbefore s$, we either have that $s \happensbefore r$ or that $s$ and $r$ are incomparable w.r.t. $\happensbefore$; note that, in both cases, $\msc$ must have one linearization where $s$ is executed before $r$\footnote{If two elements $a$ and $b$ of a set are incomparable w.r.t. a partial order $\le$, it is always possible to find a total order of the elements (that respects $\le$) where $a$ comes before $b$, or viceversa.}. The existence of such a linearization implies that $\msc$ is not $\forall k$-bounded.
	
	($\Leftarrow$) Suppose $\relbAsy \;\subseteq\; \happensbefore$ and, for each channel ($p$,$q$), there are at most $k$ unmatched send events. By definition, every linearization $\linrel$ of $\msc$ is such that $\happensbefore \;\subseteq\; \linrel$; it follows that $\relbAsy \;\subseteq\; \linrel$, which means that every linearization of $\msc$ is $k$-bounded, i.e. $\msc$ is $\forall k$-bounded.
\end{proof}

It follows that $\oneone$-$\forall k$-bounded and $\co$-$\forall k$-bounded MSCs are MSO-definable by definition, since $\oneone$-MSCs, \co-MSCs, and universally $k$-bounded MSCs are all MSO-definable. We already showed that $\relb$ is MSO-definable when considering $\oneone$ communication. The characterization for the other communication models is similar to that given in \cite{DBLP:conf/fossacs/LohreyM02}, but it uses the proper relation for each communication model.

\begin{proposition}\label{prop:mb_ukb_alt}
	An MSC $\msc$ is $\none$-$\forall k$-bounded if and only if $\relb \;\subseteq\; \mbpartial$.\\
	An MSC $\msc$ is onen-$\forall k$-bounded if and only if $\relb \;\subseteq\; \onenpartial$.\\
	An MSC $\msc$ is nn-$\forall k$-bounded if and only if $\relb \;\subseteq\; \nnbowtie$.
\end{proposition}
\begin{proof}
	We only show it for the $\none$ communication model. The proof for the other communication models works the same way. Consider an MSC $\msc$ and a $k \in \N$.
	
	($\Leftarrow$) Suppose $\relb \;\subseteq\; \mbpartial$. For every mailbox linearization $\linrel$ of $\msc$ we have that $\mbpartial \;\subseteq\; \linrel$. This implies $\relb \;\subseteq\; \linrel$, that is to say every mailbox linearization is $k$-bounded.
	
	($\Rightarrow$) Suppose $\msc$ is a $\none$-$\forall k$-bounded MSC. By definition, every mailbox linearization $\linrel$ of $\msc$ is $k$-bounded, i.e. $\relb \;\subseteq\; \linrel$, and we have $\mbpartial \;\subseteq\; \linrel$, according to the definition of mailbox linearization. Moreover, we also know that $\mbpartial \cup \relb$ is acyclic, since $\msc$ is $\exists k$-bounded and by definition every $\none$-$\forall k$-bounded MSC is also a $\none$-$\exists k$-bounded MSC. Suppose now, by contradiction, that $\relb \;\nsubseteq\; \mbpartial$. Thus, there must be at least two events $r$ and $s$ such that $r \relb s$ and $r \;\notmbpartial\; s$; we also have $s \;\notmbpartial\; r$ because of the acyclicity of $\mbpartial \cup \relb$ (we cannot have the cycle $r \relb s \mbpartial r$). Consider a mailbox linearization $\linrel$  of $\msc$, such that $s \linrel r$. Note that such a mailbox linearization always exists, since $r$ and $s$ are incomparable w.r.t. the partial order $\mbpartial$. This mailbox linearization does not respect $\relb$ (because we have $s \linrel r$ and $r \relb s$), so it is not $k$-bounded. This is a contradiction, since we assumed that $\msc$ was a $\none$-$\forall k$-bounded MSC. It has to be that $\relb \;\subseteq\; \mbpartial$.
\end{proof}

Using Proposition~\ref{prop:mb_ukb_alt}, we can now easily write the MSO formulas that define these variants of universally $k$-bounded MSCs.
\begin{align*}
	\mbUkformula &= \neg \exists r.\exists s.(r \relb s \wedge \neg(r \mbpartial s)) \\
	\onenUkformula &= \neg \exists r.\exists s.(r \relb s \wedge \neg(r \onenpartial s)) \\
	\nnUkformula &= \neg \exists r.\exists s.(r \relb s \wedge \neg(r \nnbowtie s))
\end{align*}


\paragraph*{Special treewidth}

All the variants of universally $k$-bounded MSCs that we presented have a bounded special treewidth. This directly follows from the STW-boundness of the existential counterparts, since every universally $k$-bounded MSC is existentially $k$-bounded by definition.
